from _version import __version__
import os, sys, logging
import datetime
import time
import inspect
from time import strftime, gmtime
from web3 import Web3
from web3.middleware import geth_poa_middleware
import rlp

class CeloWeb3:
    REGISTRY_CONTRACT_ADDRESS = '0x000000000000000000000000000000000000ce10'

    def __init__(self):
        # logging.basicConfig(format='%(asctime)s %(levelname)s: %(message)s',level=logging.DEBUG)
        self.celo_w3 = None
        self.registry = None
        self.election = None
        self.validators = None

    def __wait_until_node_synced(self, w3):
        # check if last block on the node is older than 30 seconds
        latest_block = w3.eth.getBlock('latest')
        time_difference = int(time.time()) - latest_block['timestamp']
        if time_difference > 30:
            logging.warning('Latest block of the connected node is older than 30 sec (#%i - %i sec ago)...' % (latest_block['number'], time_difference))
            # check if currently syncing
            while True:
                if w3.eth.syncing:
                    logging.info('Node is currently syncing. Waiting until in sync...')
                    logging.info('Waiting 10 sec...')
                    time.sleep(10)
                else:
                    logging.info('Node is not syncing.')
                    latest_block = w3.eth.getBlock('latest')
                    time_difference = int(time.time()) - latest_block['timestamp']
                    # check if block is fresh
                    if time_difference < 15:
                        logging.info('Latest block of the node is fresh (#%i - %i sec ago). Assuming in sync.' % (latest_block['number'], time_difference))
                        break
                    else:
                        logging.info('Assuming node did not start to sync yet.')
                        logging.info('Waiting 10 sec...')
                        time.sleep(10)

    def setup_web3_connection(self):
        logging.info('Connecting to Celo node...')

        default_connection_provider = 'http'
        connection_provider = os.getenv('CONNECTION_PROVIDER', default_connection_provider)

        default_connection_string = 'http://127.0.0.1:8545'
        connection_string = os.getenv('CONNECTION_STRING', default_connection_string)

        if connection_provider == 'http':
            w3 = Web3(Web3.HTTPProvider(connection_string, request_kwargs={'timeout': 60}))
        elif connection_provider == 'ipc':
            w3 = Web3(Web3.IPCProvider(connection_string, request_kwargs={'timeout': 60}))
        elif connection_provider == 'ws':
            w3 = Web3(Web3.WebsocketProvider(connection_string, websocket_kwargs={'timeout': 60}))
        else:
            logging.error('No valid connection provider found! Check the environment variable CONNECTION_PROVIDER.')
            exit(1)

        if w3.isConnected():
            logging.info('Connected via %s --> %s' % (connection_provider, connection_string))
        else:
            logging.error('Connection to the node could not be established! Check the environment variables CONNECTION_PROVIDER and CONNECTION_STRING. Is the node running?')
            logging.error('Tried to connect via %s --> %s' % (connection_provider, connection_string))
            exit(1)

        # necessary to bypass extradata length restrictions
        w3.middleware_onion.inject(geth_poa_middleware, layer=0)

        self.__wait_until_node_synced(w3)

        return w3

    def get_web3_connection(self):
        if self.celo_w3 == None:
            self.celo_w3 = self.setup_web3_connection()
        return self.celo_w3

    def get_registry_contract(self):
        if self.registry == None:
            self.registry = self.get_web3_connection().eth.contract(address=self.REGISTRY_CONTRACT_ADDRESS, abi="""[{"anonymous": false,"inputs": [{"indexed": true,"internalType": "address","name": "previousOwner","type": "address"},{"indexed": true,"internalType": "address","name": "newOwner","type": "address"}],"name": "OwnershipTransferred","type": "event"},{"anonymous": false,"inputs": [{"indexed": false,"internalType": "string","name": "identifier","type": "string"},{"indexed": true,"internalType": "bytes32","name": "identifierHash","type": "bytes32"},{"indexed": true,"internalType": "address","name": "addr","type": "address"}],"name": "RegistryUpdated","type": "event"},{"constant": true,"inputs": [{"internalType": "bytes32","name": "identifierHash","type": "bytes32"}],"name": "getAddressFor","outputs": [{"internalType": "address","name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"internalType": "bytes32","name": "identifierHash","type": "bytes32"}],"name": "getAddressForOrDie","outputs": [{"internalType": "address","name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"internalType": "string","name": "identifier","type": "string"}],"name": "getAddressForString","outputs": [{"internalType": "address","name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"internalType": "string","name": "identifier","type": "string"}],"name": "getAddressForStringOrDie","outputs": [{"internalType": "address","name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [],"name": "initialize","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [],"name": "initialized","outputs": [{"internalType": "bool","name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"internalType": "bytes32[]","name": "identifierHashes","type": "bytes32[]"},{"internalType": "address","name": "sender","type": "address"}],"name": "isOneOf","outputs": [{"internalType": "bool","name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [],"name": "isOwner","outputs": [{"internalType": "bool","name": "","type": "bool"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [],"name": "owner","outputs": [{"internalType": "address","name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"internalType": "bytes32","name": "","type": "bytes32"}],"name": "registry","outputs": [{"internalType": "address","name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [],"name": "renounceOwnership","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"internalType": "string","name": "identifier","type": "string"},{"internalType": "address","name": "addr","type": "address"}],"name": "setAddressFor","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": false,"inputs": [{"internalType": "address","name": "newOwner","type": "address"}],"name": "transferOwnership","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"}]""")
        return self.registry

    def get_validators_contract(self):
        if self.validators == None:
            validators_hash = self.get_web3_connection().solidityKeccak(['string'], ['Validators'])
            validators_contract_address = self.get_registry_contract().functions.getAddressFor(validators_hash).call()
            self.validators = self.get_web3_connection().eth.contract(address=validators_contract_address, abi="""[{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"removeMember","inputs":[{"type":"address","name":"validator"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"getMembershipInLastEpoch","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"validatorSignerAddressFromCurrentSet","inputs":[{"type":"uint256","name":"index"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"initialized","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes","name":"ecdsaPublicKey"},{"type":"bytes","name":"blsPublicKey"},{"type":"address","name":"affiliation"},{"type":"uint256","name":"score"},{"type":"address","name":"signer"}],"name":"getValidator","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"getValidatorScoreParameters","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"checkProofOfPossession","inputs":[{"type":"address","name":"sender"},{"type":"bytes","name":"blsKey"},{"type":"bytes","name":"blsPop"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"addFirstMember","inputs":[{"type":"address","name":"validator"},{"type":"address","name":"lesser"},{"type":"address","name":"greater"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256[]","name":""},{"type":"address[]","name":""},{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"getMembershipHistory","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"slashingMultiplierResetPeriod","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getGroupNumMembers","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getEpochNumberOfBlock","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"getRegisteredValidatorGroups","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getMaxGroupSize","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"getVerifiedSealBitmapFromHeader","inputs":[{"type":"bytes","name":"header"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"membershipHistoryLength","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"updateEcdsaPublicKey","inputs":[{"type":"address","name":"account"},{"type":"address","name":"signer"},{"type":"bytes","name":"ecdsaPublicKey"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getNumRegisteredValidators","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"getMembershipInLastEpochFromSigner","inputs":[{"type":"address","name":"signer"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"isValidatorGroup","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"maxGroupSize","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setGroupLockedGoldRequirements","inputs":[{"type":"uint256","name":"value"},{"type":"uint256","name":"duration"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"validatorSignerAddressFromSet","inputs":[{"type":"uint256","name":"index"},{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"deregisterValidatorGroup","inputs":[{"type":"uint256","name":"index"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"hashHeader","inputs":[{"type":"bytes","name":"header"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"setSlashingMultiplierResetPeriod","inputs":[{"type":"uint256","name":"value"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"setCommissionUpdateDelay","inputs":[{"type":"uint256","name":"delay"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"getGroupLockedGoldRequirements","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256[]","name":""}],"name":"getGroupsNumMembers","inputs":[{"type":"address[]","name":"accounts"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"updatePublicKeys","inputs":[{"type":"address","name":"account"},{"type":"address","name":"signer"},{"type":"bytes","name":"ecdsaPublicKey"},{"type":"bytes","name":"blsPublicKey"},{"type":"bytes","name":"blsPop"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"renounceOwnership","inputs":[],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"minQuorumSizeInCurrentSet","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setValidatorLockedGoldRequirements","inputs":[{"type":"uint256","name":"value"},{"type":"uint256","name":"duration"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"calculateGroupEpochScore","inputs":[{"type":"uint256[]","name":"uptimes"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"initialize","inputs":[{"type":"address","name":"registryAddress"},{"type":"uint256","name":"groupRequirementValue"},{"type":"uint256","name":"groupRequirementDuration"},{"type":"uint256","name":"validatorRequirementValue"},{"type":"uint256","name":"validatorRequirementDuration"},{"type":"uint256","name":"validatorScoreExponent"},{"type":"uint256","name":"validatorScoreAdjustmentSpeed"},{"type":"uint256","name":"_membershipHistoryLength"},{"type":"uint256","name":"_slashingMultiplierResetPeriod"},{"type":"uint256","name":"_maxGroupSize"},{"type":"uint256","name":"_commissionUpdateDelay"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"registry","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"setNextCommissionUpdate","inputs":[{"type":"uint256","name":"commission"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"numberValidatorsInCurrentSet","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getBlockNumberFromHeader","inputs":[{"type":"bytes","name":"header"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"deregisterValidator","inputs":[{"type":"uint256","name":"index"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"owner","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"getTopGroupValidators","inputs":[{"type":"address","name":"account"},{"type":"uint256","name":"n"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"isOwner","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"calculateEpochScore","inputs":[{"type":"uint256","name":"uptime"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"reorderMember","inputs":[{"type":"address","name":"validator"},{"type":"address","name":"lesserMember"},{"type":"address","name":"greaterMember"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getEpochNumber","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"numberValidatorsInSet","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""},{"type":"uint256","name":""},{"type":"uint256","name":""},{"type":"uint256","name":""},{"type":"uint256[]","name":""},{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"getValidatorGroup","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"setRegistry","inputs":[{"type":"address","name":"registryAddress"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"affiliate","inputs":[{"type":"address","name":"group"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes","name":"blsPublicKey"}],"name":"getValidatorBlsPublicKeyFromSigner","inputs":[{"type":"address","name":"signer"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"resetSlashingMultiplier","inputs":[],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getCommissionUpdateDelay","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":"value"},{"type":"uint256","name":"duration"}],"name":"validatorLockedGoldRequirements","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"updateBlsPublicKey","inputs":[{"type":"bytes","name":"blsPublicKey"},{"type":"bytes","name":"blsPop"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"updateValidatorScoreFromSigner","inputs":[{"type":"address","name":"signer"},{"type":"uint256","name":"uptime"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"getValidatorLockedGoldRequirements","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"halveSlashingMultiplier","inputs":[{"type":"address","name":"account"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"meetsAccountLockedGoldRequirements","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":"value"},{"type":"uint256","name":"duration"}],"name":"groupLockedGoldRequirements","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"addMember","inputs":[{"type":"address","name":"validator"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setValidatorScoreParameters","inputs":[{"type":"uint256","name":"exponent"},{"type":"uint256","name":"adjustmentSpeed"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"getRegisteredValidatorSigners","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"distributeEpochPaymentsFromSigner","inputs":[{"type":"address","name":"signer"},{"type":"uint256","name":"maxPayment"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"getRegisteredValidators","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getValidatorGroupSlashingMultiplier","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getAccountLockedGoldRequirement","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getEpochSize","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"commissionUpdateDelay","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setMaxGroupSize","inputs":[{"type":"uint256","name":"size"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"forceDeaffiliateIfValidator","inputs":[{"type":"address","name":"validatorAccount"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"minQuorumSize","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"updateCommission","inputs":[],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"registerValidator","inputs":[{"type":"bytes","name":"ecdsaPublicKey"},{"type":"bytes","name":"blsPublicKey"},{"type":"bytes","name":"blsPop"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"groupMembershipInEpoch","inputs":[{"type":"address","name":"account"},{"type":"uint256","name":"epochNumber"},{"type":"uint256","name":"index"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"fractionMulExp","inputs":[{"type":"uint256","name":"aNumerator"},{"type":"uint256","name":"aDenominator"},{"type":"uint256","name":"bNumerator"},{"type":"uint256","name":"bDenominator"},{"type":"uint256","name":"exponent"},{"type":"uint256","name":"_decimals"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"registerValidatorGroup","inputs":[{"type":"uint256","name":"commission"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setMembershipHistoryLength","inputs":[{"type":"uint256","name":"length"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"transferOwnership","inputs":[{"type":"address","name":"newOwner"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"isValidator","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"getParentSealBitmap","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"deaffiliate","inputs":[],"constant":false},{"type":"event","name":"MaxGroupSizeSet","inputs":[{"type":"uint256","name":"size","indexed":false}],"anonymous":false},{"type":"event","name":"CommissionUpdateDelaySet","inputs":[{"type":"uint256","name":"delay","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorScoreParametersSet","inputs":[{"type":"uint256","name":"exponent","indexed":false},{"type":"uint256","name":"adjustmentSpeed","indexed":false}],"anonymous":false},{"type":"event","name":"GroupLockedGoldRequirementsSet","inputs":[{"type":"uint256","name":"value","indexed":false},{"type":"uint256","name":"duration","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorLockedGoldRequirementsSet","inputs":[{"type":"uint256","name":"value","indexed":false},{"type":"uint256","name":"duration","indexed":false}],"anonymous":false},{"type":"event","name":"MembershipHistoryLengthSet","inputs":[{"type":"uint256","name":"length","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorRegistered","inputs":[{"type":"address","name":"validator","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorDeregistered","inputs":[{"type":"address","name":"validator","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorAffiliated","inputs":[{"type":"address","name":"validator","indexed":true},{"type":"address","name":"group","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorDeaffiliated","inputs":[{"type":"address","name":"validator","indexed":true},{"type":"address","name":"group","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorEcdsaPublicKeyUpdated","inputs":[{"type":"address","name":"validator","indexed":true},{"type":"bytes","name":"ecdsaPublicKey","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorBlsPublicKeyUpdated","inputs":[{"type":"address","name":"validator","indexed":true},{"type":"bytes","name":"blsPublicKey","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorScoreUpdated","inputs":[{"type":"address","name":"validator","indexed":true},{"type":"uint256","name":"score","indexed":false},{"type":"uint256","name":"epochScore","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorGroupRegistered","inputs":[{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"commission","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorGroupDeregistered","inputs":[{"type":"address","name":"group","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorGroupMemberAdded","inputs":[{"type":"address","name":"group","indexed":true},{"type":"address","name":"validator","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorGroupMemberRemoved","inputs":[{"type":"address","name":"group","indexed":true},{"type":"address","name":"validator","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorGroupMemberReordered","inputs":[{"type":"address","name":"group","indexed":true},{"type":"address","name":"validator","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorGroupCommissionUpdateQueued","inputs":[{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"commission","indexed":false},{"type":"uint256","name":"activationBlock","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorGroupCommissionUpdated","inputs":[{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"commission","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorEpochPaymentDistributed","inputs":[{"type":"address","name":"validator","indexed":true},{"type":"uint256","name":"validatorPayment","indexed":false},{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"groupPayment","indexed":false}],"anonymous":false},{"type":"event","name":"RegistrySet","inputs":[{"type":"address","name":"registryAddress","indexed":true}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"type":"address","name":"previousOwner","indexed":true},{"type":"address","name":"newOwner","indexed":true}],"anonymous":false}]""")
        return self.validators

    def get_election_contract(self):
        if self.election == None:
            election_hash = self.get_web3_connection().solidityKeccak(['string'], ['Election'])
            election_contract_address = self.get_registry_contract().functions.getAddressFor(election_hash).call()
            self.election = self.get_web3_connection().eth.contract(address=election_contract_address, abi="""[{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"validatorSignerAddressFromCurrentSet","inputs":[{"type":"uint256","name":"index"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"distributeEpochRewards","inputs":[{"type":"address","name":"group"},{"type":"uint256","name":"value"},{"type":"address","name":"lesser"},{"type":"address","name":"greater"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"initialized","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"activate","inputs":[{"type":"address","name":"group"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getActiveVotes","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"checkProofOfPossession","inputs":[{"type":"address","name":"sender"},{"type":"bytes","name":"blsKey"},{"type":"bytes","name":"blsPop"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"hasActivatablePendingVotes","inputs":[{"type":"address","name":"account"},{"type":"address","name":"group"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"electValidatorSigners","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getNumVotesReceivable","inputs":[{"type":"address","name":"group"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getTotalVotesForGroupByAccount","inputs":[{"type":"address","name":"group"},{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getEpochNumberOfBlock","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setMaxNumGroupsVotedFor","inputs":[{"type":"uint256","name":"_maxNumGroupsVotedFor"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"getCurrentValidatorSigners","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"getGroupsVotedForByAccount","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"getVerifiedSealBitmapFromHeader","inputs":[{"type":"bytes","name":"header"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":"value"}],"name":"electabilityThreshold","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"vote","inputs":[{"type":"address","name":"group"},{"type":"uint256","name":"value"},{"type":"address","name":"lesser"},{"type":"address","name":"greater"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getActiveVoteUnitsForGroup","inputs":[{"type":"address","name":"group"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"validatorSignerAddressFromSet","inputs":[{"type":"uint256","name":"index"},{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setElectabilityThreshold","inputs":[{"type":"uint256","name":"threshold"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"hashHeader","inputs":[{"type":"bytes","name":"header"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getTotalVotesByAccount","inputs":[{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"revokeActive","inputs":[{"type":"address","name":"group"},{"type":"uint256","name":"value"},{"type":"address","name":"lesser"},{"type":"address","name":"greater"},{"type":"uint256","name":"index"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":"groups"},{"type":"uint256[]","name":"values"}],"name":"getTotalVotesForEligibleValidatorGroups","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"renounceOwnership","inputs":[],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"minQuorumSizeInCurrentSet","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"registry","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"numberValidatorsInCurrentSet","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getBlockNumberFromHeader","inputs":[{"type":"bytes","name":"header"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"getGroupEligibility","inputs":[{"type":"address","name":"group"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address","name":""}],"name":"owner","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"forceDecrementVotes","inputs":[{"type":"address","name":"account"},{"type":"uint256","name":"value"},{"type":"address[]","name":"lessers"},{"type":"address[]","name":"greaters"},{"type":"uint256[]","name":"indices"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"isOwner","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"electNValidatorSigners","inputs":[{"type":"uint256","name":"minElectableValidators"},{"type":"uint256","name":"maxElectableValidators"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getActiveVotesForGroup","inputs":[{"type":"address","name":"group"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getPendingVotesForGroup","inputs":[{"type":"address","name":"group"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getTotalVotes","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getEpochNumber","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"numberValidatorsInSet","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getPendingVotesForGroupByAccount","inputs":[{"type":"address","name":"group"},{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"revokePending","inputs":[{"type":"address","name":"group"},{"type":"uint256","name":"value"},{"type":"address","name":"lesser"},{"type":"address","name":"greater"},{"type":"uint256","name":"index"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"markGroupEligible","inputs":[{"type":"address","name":"group"},{"type":"address","name":"lesser"},{"type":"address","name":"greater"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getActiveVoteUnitsForGroupByAccount","inputs":[{"type":"address","name":"group"},{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"address[]","name":""}],"name":"getEligibleValidatorGroups","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"markGroupIneligible","inputs":[{"type":"address","name":"group"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"setRegistry","inputs":[{"type":"address","name":"registryAddress"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"maxNumGroupsVotedFor","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getElectabilityThreshold","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getActiveVotesForGroupByAccount","inputs":[{"type":"address","name":"group"},{"type":"address","name":"account"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getTotalVotesForGroup","inputs":[{"type":"address","name":"group"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getEpochSize","inputs":[],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"revokeAllActive","inputs":[{"type":"address","name":"group"},{"type":"address","name":"lesser"},{"type":"address","name":"greater"},{"type":"uint256","name":"index"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"minQuorumSize","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bool","name":""}],"name":"canReceiveVotes","inputs":[{"type":"address","name":"group"},{"type":"uint256","name":"value"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"fractionMulExp","inputs":[{"type":"uint256","name":"aNumerator"},{"type":"uint256","name":"aDenominator"},{"type":"uint256","name":"bNumerator"},{"type":"uint256","name":"bDenominator"},{"type":"uint256","name":"exponent"},{"type":"uint256","name":"_decimals"}],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"getGroupEpochRewards","inputs":[{"type":"address","name":"group"},{"type":"uint256","name":"totalEpochRewards"},{"type":"uint256[]","name":"uptimes"}],"constant":true},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"transferOwnership","inputs":[{"type":"address","name":"newOwner"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[{"type":"bool","name":""}],"name":"setElectableValidators","inputs":[{"type":"uint256","name":"min"},{"type":"uint256","name":"max"}],"constant":false},{"type":"function","stateMutability":"nonpayable","payable":false,"outputs":[],"name":"initialize","inputs":[{"type":"address","name":"registryAddress"},{"type":"uint256","name":"minElectableValidators"},{"type":"uint256","name":"maxElectableValidators"},{"type":"uint256","name":"_maxNumGroupsVotedFor"},{"type":"uint256","name":"_electabilityThreshold"}],"constant":false},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":"min"},{"type":"uint256","name":"max"}],"name":"electableValidators","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"uint256","name":""},{"type":"uint256","name":""}],"name":"getElectableValidators","inputs":[],"constant":true},{"type":"function","stateMutability":"view","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"getParentSealBitmap","inputs":[{"type":"uint256","name":"blockNumber"}],"constant":true},{"type":"event","name":"ElectableValidatorsSet","inputs":[{"type":"uint256","name":"min","indexed":false},{"type":"uint256","name":"max","indexed":false}],"anonymous":false},{"type":"event","name":"MaxNumGroupsVotedForSet","inputs":[{"type":"uint256","name":"maxNumGroupsVotedFor","indexed":false}],"anonymous":false},{"type":"event","name":"ElectabilityThresholdSet","inputs":[{"type":"uint256","name":"electabilityThreshold","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorGroupMarkedEligible","inputs":[{"type":"address","name":"group","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorGroupMarkedIneligible","inputs":[{"type":"address","name":"group","indexed":true}],"anonymous":false},{"type":"event","name":"ValidatorGroupVoteCast","inputs":[{"type":"address","name":"account","indexed":true},{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"value","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorGroupVoteActivated","inputs":[{"type":"address","name":"account","indexed":true},{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"value","indexed":false},{"type":"uint256","name":"units","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorGroupPendingVoteRevoked","inputs":[{"type":"address","name":"account","indexed":true},{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"value","indexed":false}],"anonymous":false},{"type":"event","name":"ValidatorGroupActiveVoteRevoked","inputs":[{"type":"address","name":"account","indexed":true},{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"value","indexed":false},{"type":"uint256","name":"units","indexed":false}],"anonymous":false},{"type":"event","name":"EpochRewardsDistributedToVoters","inputs":[{"type":"address","name":"group","indexed":true},{"type":"uint256","name":"value","indexed":false}],"anonymous":false},{"type":"event","name":"RegistrySet","inputs":[{"type":"address","name":"registryAddress","indexed":true}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"type":"address","name":"previousOwner","indexed":true},{"type":"address","name":"newOwner","indexed":true}],"anonymous":false}]""")
        return self.election

    def get_latest_block(self):
        latest_block = self.get_web3_connection().eth.getBlock('latest')
        return latest_block

    def get_validator_count(self, block_number):
        validator_count = self.get_election_contract().functions.numberValidatorsInSet(block_number).call()
        return self.check_for_evm_error(validator_count, inspect.currentframe().f_code.co_name)

    def get_validator_id(self, signer_address):
        latest_block = self.get_latest_block()
        latest_block_number = latest_block['number']
        logging.info('Current block: #%s' % latest_block_number)
        
        validator_count = self.get_validator_count(latest_block_number)
        logging.info('Number of validators in current set: %s' % validator_count)

        signer_address_index = -1
        logging.info('Getting validator ID for signer address: %s...' % signer_address)
        for i in range(validator_count):
            validator_address = self.get_election_contract().functions.validatorSignerAddressFromSet(i, latest_block_number).call()

            if self.check_for_evm_error(int(validator_address,16), inspect.currentframe().f_code.co_name) == None:
                return None
            
            if validator_address == signer_address:
                signer_address_index = i
                logging.info('Found ID: %i' % i)
                break
        
        if signer_address_index == -1:
            logging.error('Could not find signer address %s in the current validator set.' % signer_address)
            exit(1)
        return signer_address_index

    def get_epoch_info(self):
        latest_block = self.get_web3_connection().eth.getBlock('latest')
        validators = self.get_validators_contract()
        epoch_size = validators.functions.getEpochSize().call()
        epoch_number = (latest_block['number'] // epoch_size) + 1
        epoch_end_block_number = epoch_number * epoch_size
        logging.info('Current epoch (%i) ends at block: #%i' % (epoch_number, epoch_end_block_number))

        # print blocks, time and target datetime until next epoch
        seconds_until_epoch = (epoch_end_block_number - latest_block['number']) * 5
        time_delta = strftime("%Hh%Mm%Ss", gmtime(seconds_until_epoch))
        target_time = datetime.datetime.utcnow() + datetime.timedelta(seconds=seconds_until_epoch)
        logging.info('Next epoch in %i blocks = T-%s = %s UTC' % ((epoch_end_block_number - latest_block['number']), time_delta, target_time))

        return (epoch_size, epoch_number, epoch_end_block_number)

    def decode_signing_bitmap(self, block):
        validator_count = self.get_validator_count(block['number'])

        if validator_count == None:
            return None
        
        extra_data = rlp.decode(block['proofOfAuthorityData'][32:])
        bitmap_int = int(extra_data[5][0].hex(), 16)
        bitmap_bin = bin(bitmap_int)[2:]
        bitmap = bitmap_bin.zfill(validator_count)[::-1]
        return bitmap

    def get_signer_bit(self, block, signer_id):
        bitmap = self.decode_signing_bitmap(block)
        if bitmap == None:
            logging.error('Cannot get signer bit because bitmap is None')
            return 'unknown'
        if len(bitmap) < (signer_id + 1):
            logging.error('The bitmap is not long enough to query the bit of interest for the validator ID!') # should never happen because of the zfill fix
            logging.error('Bitmap for block %s: %s' % (block['number'], bitmap))
            return 'unknown'
        else:
            return bitmap[signer_id]
    
    def check_for_evm_error(self, int_value, trace):
        if hex(int_value) == '0x8c379a000000000000000000000000000000000000000000000000000000000':
            logging.error('EVM ERROR in %s' % trace)
            return None
        else:
            return int_value